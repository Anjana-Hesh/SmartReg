<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/license.css">

</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <h1><i class="fas fa-users-cog"></i> Driver Management System</h1>
    <p>Comprehensive solution for managing driver licenses and vehicle information</p>
  </div>

  <!-- Main Content -->
  <div class="row">

    <!-- Right Side - Driver Management -->
    <div class="">
      <div class="management-section">
        <h3 class="section-title">
          <i class="fas fa-users"></i>
          Driver Management
        </h3>

        <!-- Enhanced Search and Filter -->
        <div class="row mb-4">
          <div class="col-md-8">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" id="searchDriver" class="form-control" placeholder="Search by name, NIC or license number...">
              <button class="btn btn-outline-secondary" type="button" id="advancedFilterBtn">
                <i class="fas fa-sliders-h"></i>
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <select id="sortBy" class="form-select" onchange="sortDrivers()">
              <option value="name_asc">Sort by: Name (A-Z)</option>
              <option value="name_desc">Sort by: Name (Z-A)</option>
              <option value="expiry_asc">Sort by: Expiry (Soonest)</option>
              <option value="expiry_desc">Sort by: Expiry (Latest)</option>
            </select>
          </div>
        </div>

        <!-- Advanced Filters (Initially hidden) -->
        <div id="advancedFilters" class="row mb-4 hidden">
          <div class="col-md-4">
            <label for="filterLicenseType" class="form-label">License Type</label>
            <select id="filterLicenseType" class="form-select" onchange="applyFilters()">
              <option value="">All Types</option>
              <option value="A">Class A - Motorcycles (2-wheelers)</option>
              <option value="A1">Class A1 - Light Motorcycles (up to 50cc)</option>
              <option value="B">Class B - Motor Cars, Jeeps, Vans (up to 3500kg)</option>
              <option value="B1">Class B1 - Light Vehicles (auto transmission only)</option>
              <option value="C">Class C - Light Trucks (3500kg-17000kg)</option>
              <option value="C1">Class C1 - Medium Trucks (17000kg-25000kg)</option>
              <option value="D">Class D - Heavy Trucks (over 25000kg)</option>
              <option value="E">Class E - Heavy Tractors/Trailers</option>
              <option value="G">Class G - Road Rollers/Construction Equipment</option>
              <option value="J">Class J - Agricultural Tractors</option>
              <option value="M">Class M - Three-wheelers</option>
              <option value="P">Class P - Passenger Transport Vehicles (Buses)</option>
              <option value="P1">Class P1 - Light Passenger Vehicles (up to 12 seats)</option>
              <option value="P2">Class P2 - Medium Passenger Vehicles (13-32 seats)</option>
              <option value="P3">Class P3 - Heavy Passenger Vehicles (33+ seats)</option>
              <option value="W">Class W - Special Purpose Vehicles</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="filterStatus" class="form-label">Status</label>
            <select id="filterStatus" class="form-select" onchange="applyFilters()">
              <option value="">All Statuses</option>
              <option value="active">Active</option>
              <option value="pending">Pending</option>
              <option value="expired">Expired</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="filterExam" class="form-label">Exam Status</label>
            <select id="filterExam" class="form-select" onchange="applyFilters()">
              <option value="">All</option>
              <option value="passed">Passed</option>
              <option value="failed">Failed</option>
              <option value="not_taken">Not Taken</option>
            </select>
          </div>
        </div>

        <!-- Stats Summary -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stat-item">
              <div class="stat-value" id="totalDrivers">0</div>
              <div class="stat-label">Total Drivers</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-item">
              <div class="stat-value text-warning" id="expiringSoon">0</div>
              <div class="stat-label">Expiring Soon</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-item">
              <div class="stat-value text-success" id="passedExams">0</div>
              <div class="stat-label">Passed Exams</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-item">
              <div class="stat-value text-danger" id="expiredLicenses">0</div>
              <div class="stat-label">Expired Licenses</div>
            </div>
          </div>
        </div>

        <!-- Drivers List -->
        <div id="driversList" class="mb-4">
          <!-- Driver cards will be populated here -->
        </div>

        <!-- Pagination -->
        <nav aria-label="Driver pagination">
          <ul class="pagination" id="pagination">
            <!-- Pagination will be generated here -->
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Add Driver Modal -->
<div class="modal fade" id="addDriverModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-user-plus"></i> Add New Driver</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addDriverForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="newDriverName" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="newDriverName" required>
            </div>
            <div class="col-md-6">
              <label for="newDriverNIC" class="form-label">NIC Number</label>
              <input type="text" class="form-control" id="newDriverNIC" required>
            </div>
            <div class="col-md-6">
              <label for="newDriverDOB" class="form-label">Date of Birth</label>
              <input type="date" class="form-control" id="newDriverDOB" required>
            </div>
            <div class="col-md-6">
              <label for="newDriverLicenseType" class="form-label">License Type</label>
              <select class="form-select" id="newDriverLicenseType" required>
                <option value="">Select Type</option>
                <option value="Learner">Learner's License</option>
                <option value="Full">Full License</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="newDriverVehicleClass" class="form-label">Vehicle Class</label>
              <select class="form-select" id="newDriverVehicleClass" required>
                <option value="">Select Class</option>
                <option value="A">Class A - Motorcycles (2-wheelers)</option>
                <option value="A1">Class A1 - Light Motorcycles (up to 50cc)</option>
                <option value="B">Class B - Motor Cars, Jeeps, Vans (up to 3500kg)</option>
                <option value="B1">Class B1 - Light Vehicles (auto transmission only)</option>
                <option value="C">Class C - Light Trucks (3500kg-17000kg)</option>
                <option value="C1">Class C1 - Medium Trucks (17000kg-25000kg)</option>
                <option value="D">Class D - Heavy Trucks (over 25000kg)</option>
                <option value="E">Class E - Heavy Tractors/Trailers</option>
                <option value="G">Class G - Road Rollers/Construction Equipment</option>
                <option value="J">Class J - Agricultural Tractors</option>
                <option value="M">Class M - Three-wheelers</option>
                <option value="P">Class P - Passenger Transport Vehicles (Buses)</option>
                <option value="P1">Class P1 - Light Passenger Vehicles (up to 12 seats)</option>
                <option value="P2">Class P2 - Medium Passenger Vehicles (13-32 seats)</option>
                <option value="P3">Class P3 - Heavy Passenger Vehicles (33+ seats)</option>
                <option value="W">Class W - Special Purpose Vehicles</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="newDriverExamDate" class="form-label">Exam Date</label>
              <input type="date" class="form-control" id="newDriverExamDate" required>
            </div>
            <div class="col-md-6">
              <label for="newDriverPhoto" class="form-label">Passport Photo</label>
              <input type="file" class="form-control" id="newDriverPhoto" accept="image/*" required>
            </div>
            <div class="col-md-6">
              <label for="newDriverMedical" class="form-label">Medical Report</label>
              <input type="file" class="form-control" id="newDriverMedical" accept="application/pdf" required>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addNewDriver()">Save Driver</button>
      </div>
    </div>
  </div>
</div>

<!-- Driver Details Modal -->
<div class="modal fade" id="driverDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
      <div class="modal-header">
        <h5 class="modal-title" id="driverModalTitle">Driver Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="driverModalBody">
        <!-- Content will be dynamically inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveDriverChanges">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  // Enhanced Data Structure
  let drivers = [
    {
      id: 1,
      nic: "199912345678",
      name: "John Doe",
      dob: "1999-05-15",
      licenseNumber: "B1234567",
      licenseType: "Full",
      vehicleClass: "B",
      issueDate: "2023-01-15",
      expiryDate: "2028-01-15",
      examMarks: 85,
      examDate: "2023-01-10",
      trialDate: "2023-02-15",
      status: "active",
      image: "https://randomuser.me/api/portraits/men/1.jpg",
      medicalReport: "medical_report_1.pdf"
    },
    {
      id: 2,
      nic: "199987654321",
      name: "Jane Smith",
      dob: "1999-08-20",
      licenseNumber: "C2345678",
      licenseType: "Full",
      vehicleClass: "C",
      issueDate: "2022-06-10",
      expiryDate: "2027-06-10",
      examMarks: 25,
      examDate: "2022-06-05",
      retakeDate: "2022-07-10",
      status: "pending",
      image: "https://randomuser.me/api/portraits/women/1.jpg",
      medicalReport: null
    },
    {
      id: 3,
      nic: "198512345678",
      name: "Mike Johnson",
      dob: "1985-03-20",
      licenseNumber: "A3456789",
      licenseType: "Full",
      vehicleClass: "A",
      issueDate: "2021-03-20",
      expiryDate: "2026-03-20",
      examMarks: 92,
      examDate: "2021-03-15",
      trialDate: "2021-04-20",
      status: "active",
      image: "https://randomuser.me/api/portraits/men/2.jpg",
      medicalReport: "medical_report_3.pdf"
    },
    {
      id: 4,
      nic: "200012345678",
      name: "Sarah Williams",
      dob: "2000-11-05",
      licenseNumber: "B4567890",
      licenseType: "Learner",
      vehicleClass: "B",
      issueDate: "2023-05-01",
      expiryDate: "2023-11-01",
      examMarks: 78,
      examDate: "2023-04-25",
      trialDate: "2023-06-01",
      status: "active",
      image: "https://randomuser.me/api/portraits/women/2.jpg",
      medicalReport: "medical_report_4.pdf"
    },
    {
      id: 5,
      nic: "199512345678",
      name: "David Brown",
      dob: "1995-07-15",
      licenseNumber: "D5678901",
      licenseType: "Full",
      vehicleClass: "D",
      issueDate: "2020-01-10",
      expiryDate: "2025-01-10",
      examMarks: 65,
      examDate: "2019-12-15",
      trialDate: "2020-02-10",
      status: "expired",
      image: "https://randomuser.me/api/portraits/men/3.jpg",
      medicalReport: "medical_report_5.pdf"
    }
  ];

  // Pagination variables
  let currentPage = 1;
  const driversPerPage = 5;
  let filteredDrivers = [];

  // Initialize the application
  $(document).ready(function() {
    renderDriversList();
    setupEventListeners();
    updateStats();
  });

  // Setup event listeners
  function setupEventListeners() {
    // Search functionality
    $('#searchDriver').on('input', function() {
      currentPage = 1;
      applyFilters();
    });

    // Advanced filter toggle
    $('#advancedFilterBtn').click(function() {
      $('#advancedFilters').toggleClass('hidden');
    });

    // Modal events
    $('#addDriverModal').on('hidden.bs.modal', function() {
      $('#addDriverForm')[0].reset();
    });
  }

  // Render drivers list with pagination
  function renderDriversList(driversToRender = drivers) {
    filteredDrivers = driversToRender;
    updateStats();

    const container = $('#driversList');
    container.empty();

    const totalPages = Math.ceil(filteredDrivers.length / driversPerPage);
    const startIndex = (currentPage - 1) * driversPerPage;
    const endIndex = Math.min(startIndex + driversPerPage, filteredDrivers.length);
    const paginatedDrivers = filteredDrivers.slice(startIndex, endIndex);

    if (paginatedDrivers.length === 0) {
      container.append(`
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> No drivers found matching your criteria
        </div>
      `);
    } else {
      paginatedDrivers.forEach(driver => {
        const card = createDriverCard(driver);
        container.append(card);
      });
    }

    renderPagination(totalPages);
  }

  function createDriverCard(driver) {
    const licenseTypeMap = {
      'A': 'Motorcycle',
      'B': 'Car',
      'C': 'Truck',
      'D': 'Bus',
      'CE': 'Heavy Vehicle'
    };

    const statusClass = driver.status === 'active' ? 'status-active' :
            driver.status === 'pending' ? 'status-pending' : 'status-expired';

    const expiryDate = new Date(driver.expiryDate);
    const today = new Date();
    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
    const expiryWarning = daysUntilExpiry <= 30 ? `<span class="badge bg-warning">Expires in ${daysUntilExpiry} days</span>` : '';

    let examStatus = '';
    if (driver.examMarks === null) {
      examStatus = '<span class="badge bg-secondary">Not Taken</span>';
    } else if (driver.examMarks >= 75) {
      examStatus = `<span class="badge bg-success">Passed (${driver.examMarks}%)</span>`;
    } else if (driver.examMarks >= 30) {
      examStatus = `<span class="badge bg-warning">Trial (${driver.examMarks}%)</span>`;
    } else {
      examStatus = `<span class="badge bg-danger">Failed (${driver.examMarks}%)</span>`;
    }

    return `
      <div class="driver-card mb-3" data-id="${driver.id}">
        <div class="driver-info">
          <div>
            <div class="driver-name">${driver.name} <small class="text-muted">${driver.nic}</small></div>
            <div class="driver-license">${driver.licenseNumber} • ${licenseTypeMap[driver.vehicleClass] || driver.vehicleClass}</div>
          </div>
          <div>
            <span class="status-badge ${statusClass}">${driver.status}</span>
            ${expiryWarning}
          </div>
        </div>

        <div class="driver-stats">
          <div class="stat-item">
            <div class="stat-value">${driver.licenseType}</div>
            <div class="stat-label">License Type</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${driver.issueDate}</div>
            <div class="stat-label">Issued</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${driver.expiryDate}</div>
            <div class="stat-label">Expires</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${examStatus}</div>
            <div class="stat-label">Exam</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-sm btn-primary" onclick="viewDriverDetails(${driver.id})">
            <i class="fas fa-eye"></i> View
          </button>
          <button class="btn btn-sm btn-warning" onclick="editDriver(${driver.id})">
            <i class="fas fa-edit"></i> Edit
          </button>
          <button class="btn btn-sm btn-danger" onclick="confirmDeleteDriver(${driver.id})">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </div>
    `;
  }

  function renderPagination(totalPages) {
    const pagination = $('#pagination');
    pagination.empty();

    if (totalPages <= 1) return;

    pagination.append(`
      <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
          <i class="fas fa-chevron-left"></i>
        </a>
      </li>
    `);

    for (let i = 1; i <= totalPages; i++) {
      pagination.append(`
        <li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
        </li>
      `);
    }

    pagination.append(`
      <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
          <i class="fas fa-chevron-right"></i>
        </a>
      </li>
    `);
  }

  function changePage(page) {
    if (page < 1 || page > Math.ceil(filteredDrivers.length / driversPerPage)) return;
    currentPage = page;
    renderDriversList(filteredDrivers);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function applyFilters() {
    const searchTerm = $('#searchDriver').val().toLowerCase();
    const licenseType = $('#filterLicenseType').val();
    const status = $('#filterStatus').val();
    const examStatus = $('#filterExam').val();

    let filtered = drivers;

    if (searchTerm) {
      filtered = filtered.filter(driver =>
              driver.name.toLowerCase().includes(searchTerm) ||
              driver.nic.includes(searchTerm) ||
              driver.licenseNumber.toLowerCase().includes(searchTerm)
      );
    }

    if (licenseType) {
      filtered = filtered.filter(driver => driver.vehicleClass === licenseType);
    }

    if (status) {
      filtered = filtered.filter(driver => driver.status === status);
    }

    if (examStatus) {
      if (examStatus === 'passed') {
        filtered = filtered.filter(driver => driver.examMarks !== null && driver.examMarks >= 75);
      } else if (examStatus === 'failed') {
        filtered = filtered.filter(driver => driver.examMarks !== null && driver.examMarks < 75);
      } else if (examStatus === 'not_taken') {
        filtered = filtered.filter(driver => driver.examMarks === null);
      }
    }

    renderDriversList(filtered);
  }

  function sortDrivers() {
    const sortBy = $('#sortBy').val();
    let sorted = [...filteredDrivers];

    switch (sortBy) {
      case 'name_asc':
        sorted.sort((a, b) => a.name.localeCompare(b.name));
        break;
      case 'name_desc':
        sorted.sort((a, b) => b.name.localeCompare(a.name));
        break;
      case 'expiry_asc':
        sorted.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
        break;
      case 'expiry_desc':
        sorted.sort((a, b) => new Date(b.expiryDate) - new Date(a.expiryDate));
        break;
    }

    renderDriversList(sorted);
  }

  function filterDrivers(status) {
    $('#filterStatus').val(status);
    applyFilters();
  }

  function updateStats() {
    const today = new Date();
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(today.getDate() + 30);

    $('#totalDrivers').text(filteredDrivers.length);

    const activeCount = filteredDrivers.filter(d => d.status === 'active').length;
    $('#activeCount').text(activeCount);

    const pendingCount = filteredDrivers.filter(d => d.status === 'pending').length;
    $('#pendingCount').text(pendingCount);

    const expiredCount = filteredDrivers.filter(d => d.status === 'expired').length;
    $('#expiredCount').text(expiredCount);

    const expiringSoon = filteredDrivers.filter(d => {
      if (d.status !== 'active') return false;
      const expiryDate = new Date(d.expiryDate);
      return expiryDate > today && expiryDate <= thirtyDaysFromNow;
    }).length;
    $('#expiringSoon').text(expiringSoon);

    const passedExams = filteredDrivers.filter(d => d.examMarks !== null && d.examMarks >= 75).length;
    $('#passedExams').text(passedExams);

    const expiredLicenses = filteredDrivers.filter(d => {
      if (d.status === 'expired') return true;
      const expiryDate = new Date(d.expiryDate);
      return d.status === 'active' && expiryDate < today;
    }).length;
    $('#expiredLicenses').text(expiredLicenses);
  }

  function addNewDriver() {
    const form = $('#addDriverForm')[0];
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const newDriver = {
      id: drivers.length > 0 ? Math.max(...drivers.map(d => d.id)) + 1 : 1,
      nic: $('#newDriverNIC').val(),
      name: $('#newDriverName').val(),
      dob: $('#newDriverDOB').val(),
      licenseNumber: generateLicenseNumber(),
      licenseType: $('#newDriverLicenseType').val(),
      vehicleClass: $('#newDriverVehicleClass').val(),
      issueDate: new Date().toISOString().split('T')[0],
      expiryDate: calculateExpiryDate($('#newDriverLicenseType').val()),
      examMarks: null,
      examDate: $('#newDriverExamDate').val(),
      trialDate: null,
      retakeDate: null,
      status: 'pending',
      image: null,
      medicalReport: $('#newDriverMedical').val().split('\\').pop()
    };

    drivers.push(newDriver);

    Swal.fire({
      title: 'Success!',
      text: 'Driver added successfully',
      icon: 'success',
      confirmButtonText: 'OK'
    }).then(() => {
      $('#addDriverModal').modal('hide');
      renderDriversList();
    });
  }

  function generateLicenseNumber() {
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const numbers = '0123456789';
    let result = letters.charAt(Math.floor(Math.random() * letters.length));

    for (let i = 0; i < 7; i++) {
      result += numbers.charAt(Math.floor(Math.random() * numbers.length));
    }

    return result;
  }

  function calculateExpiryDate(licenseType) {
    const today = new Date();
    const expiryDate = new Date(today);

    if (licenseType === 'Learner') {
      expiryDate.setMonth(today.getMonth() + 6); // 6 months for learner
    } else {
      expiryDate.setFullYear(today.getFullYear() + 5); // 5 years for full
    }

    return expiryDate.toISOString().split('T')[0];
  }

  function viewDriverDetails(driverId) {
    const driver = drivers.find(d => d.id === driverId);
    if (!driver) return;

    const modalTitle = $('#driverModalTitle');
    const modalBody = $('#driverModalBody');

    modalTitle.html(`<i class="fas fa-user"></i> ${driver.name} (${driver.licenseNumber})`);

    const today = new Date();
    const expiryDate = new Date(driver.expiryDate);
    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
    const expiryStatus = daysUntilExpiry > 0 ?
            `<span class="text-success">Expires in ${daysUntilExpiry} days</span>` :
            `<span class="text-danger">Expired ${Math.abs(daysUntilExpiry)} days ago</span>`;

    modalBody.html(`
      <div class="row">
        <div class="col-md-4 text-center">
          <img src="${driver.image || 'https://via.placeholder.com/150'}"
               class="img-fluid rounded-circle mb-3" alt="Driver Photo">
          <h4>${driver.name}</h4>
          <p class="text-muted">NIC: ${driver.nic}</p>
          <p>Date of Birth: ${driver.dob}</p>
        </div>
        <div class="col-md-8">
          <div class="card mb-3" style="background:whitesmoke;">
            <div class="card-header">
              <h5><i class="fas fa-id-card"></i> License Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>License Number:</strong> ${driver.licenseNumber}</p>
                  <p><strong>License Type:</strong> ${driver.licenseType}</p>
                  <p><strong>Vehicle Class:</strong> ${driver.vehicleClass}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>Issue Date:</strong> ${driver.issueDate}</p>
                  <p><strong>Expiry Date:</strong> ${driver.expiryDate} (${expiryStatus})</p>
                  <p><strong>Status:</strong> <span class="status-badge ${driver.status === 'active' ? 'status-active' :
            driver.status === 'pending' ? 'status-pending' : 'status-expired'}">${driver.status}</span></p>
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="background: white;">
            <div class="card-header">
              <h5><i class="fas fa-clipboard-check"></i> Exam Information</h5>
            </div>
            <div class="card-body">
              ${driver.examMarks !== null ? `
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Exam Date:</strong> ${driver.examDate}</p>
                    <p><strong>Marks:</strong> ${driver.examMarks}%</p>
                    <p><strong>Result:</strong>
                      ${driver.examMarks >= 75 ?
            '<span class="badge bg-success">Passed</span>' :
            driver.examMarks >= 30 ?
                    '<span class="badge bg-warning">Trial</span>' :
                    '<span class="badge bg-danger">Failed</span>'}
                    </p>
                  </div>
                  <div class="col-md-6">
                    ${driver.examMarks >= 30 && driver.examMarks < 75 ? `
                      <p><strong>Trial Date:</strong> ${driver.trialDate || 'Not set'}</p>
                    ` : ''}
                    ${driver.examMarks < 30 ? `
                      <p><strong>Retake Date:</strong> ${driver.retakeDate || 'Not set'}</p>
                    ` : ''}
                  </div>
                </div>
              ` : '<p class="text-muted">No exam information available</p>'}
            </div>
          </div>
        </div>
      </div>
    `);

    const modal = new bootstrap.Modal(document.getElementById('driverDetailsModal'));
    modal.show();
  }

  function editDriver(driverId) {
    const driver = drivers.find(d => d.id === driverId);
    if (!driver) return;

    const modalTitle = $('#driverModalTitle');
    const modalBody = $('#driverModalBody');

    modalTitle.html(`<i class="fas fa-edit"></i> Edit Driver: ${driver.name}`);

    modalBody.html(`
      <form id="editDriverForm">
        <input type="hidden" id="editDriverId" value="${driver.id}">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="editDriverName" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="editDriverName" value="${driver.name}" required>
          </div>
          <div class="col-md-6">
            <label for="editDriverNIC" class="form-label">NIC Number</label>
            <input type="text" class="form-control" id="editDriverNIC" value="${driver.nic}" required>
          </div>
          <div class="col-md-6">
            <label for="editDriverLicenseType" class="form-label">License Type</label>
            <select class="form-select" id="editDriverLicenseType" required>
              <option value="Learner" ${driver.licenseType === 'Learner' ? 'selected' : ''}>Learner's License</option>
              <option value="Full" ${driver.licenseType === 'Full' ? 'selected' : ''}>Full License</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="editDriverVehicleClass" class="form-label">Vehicle Class</label>
            <select class="form-select" id="editDriverVehicleClass" required>
              <option value="A" ${driver.vehicleClass === 'A' ? 'selected' : ''}>Class A - Motorcycles</option>
              <option value="B" ${driver.vehicleClass === 'B' ? 'selected' : ''}>Class B - Cars</option>
              <option value="C" ${driver.vehicleClass === 'C' ? 'selected' : ''}>Class C - Trucks</option>
              <option value="D" ${driver.vehicleClass === 'D' ? 'selected' : ''}>Class D - Buses</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="editDriverIssueDate" class="form-label">Issue Date</label>
            <input type="date" class="form-control" id="editDriverIssueDate" value="${driver.issueDate}" required>
          </div>
          <div class="col-md-6">
            <label for="editDriverExpiryDate" class="form-label">Expiry Date</label>
            <input type="date" class="form-control" id="editDriverExpiryDate" value="${driver.expiryDate}" required>
          </div>
          <div class="col-md-6">
            <label for="editDriverExamMarks" class="form-label">Exam Marks</label>
            <input type="number" class="form-control" id="editDriverExamMarks"
                   value="${driver.examMarks || ''}" min="0" max="100" onchange="toggleExamDateFields(this.value)">
          </div>
          <div class="col-md-6">
            <label for="editDriverExamDate" class="form-label">Exam Date</label>
            <input type="date" class="form-control" id="editDriverExamDate" value="${driver.examDate || ''}">
          </div>

          <div class="col-md-6" id="trialDateGroup" style="display: ${driver.examMarks >= 30 && driver.examMarks < 75 ? 'block' : 'none'}">
            <label for="editDriverTrialDate" class="form-label">Trial Date</label>
            <input type="date" class="form-control" id="editDriverTrialDate" value="${driver.trialDate || ''}">
          </div>

          <div class="col-md-6" id="retakeDateGroup" style="display: ${driver.examMarks < 30 ? 'block' : 'none'}">
            <label for="editDriverRetakeDate" class="form-label">Retake Date</label>
            <input type="date" class="form-control" id="editDriverRetakeDate" value="${driver.retakeDate || ''}">
          </div>

          <div class="col-md-6">
            <label for="editDriverStatus" class="form-label">Status</label>
            <select class="form-select" id="editDriverStatus" required>
              <option value="active" ${driver.status === 'active' ? 'selected' : ''}>Active</option>
              <option value="pending" ${driver.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="expired" ${driver.status === 'expired' ? 'selected' : ''}>Expired</option>
            </select>
          </div>
        </div>
      </form>
    `);

    // Initialize the fields based on current exam marks
    toggleExamDateFields(driver.examMarks || 0);

    $('#saveDriverChanges').off('click').on('click', function() {
      saveDriverChanges(driverId);
    });

    const modal = new bootstrap.Modal(document.getElementById('driverDetailsModal'));
    modal.show();
  }

  function toggleExamDateFields(examMarks) {
    examMarks = parseInt(examMarks) || 0;

    if (examMarks >= 30 && examMarks < 75) {
      $('#trialDateGroup').show();
      $('#retakeDateGroup').hide();
    } else if (examMarks < 30) {
      $('#trialDateGroup').hide();
      $('#retakeDateGroup').show();
    } else {
      $('#trialDateGroup').hide();
      $('#retakeDateGroup').hide();
    }
  }

  function saveDriverChanges(driverId) {
    const driverIndex = drivers.findIndex(d => d.id === driverId);
    if (driverIndex === -1) return;

    const form = $('#editDriverForm')[0];
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const examMarks = $('#editDriverExamMarks').val() ? parseInt($('#editDriverExamMarks').val()) : null;

    drivers[driverIndex] = {
      ...drivers[driverIndex],
      name: $('#editDriverName').val(),
      nic: $('#editDriverNIC').val(),
      licenseType: $('#editDriverLicenseType').val(),
      vehicleClass: $('#editDriverVehicleClass').val(),
      issueDate: $('#editDriverIssueDate').val(),
      expiryDate: $('#editDriverExpiryDate').val(),
      examMarks: examMarks,
      examDate: $('#editDriverExamDate').val(),
      trialDate: examMarks >= 30 && examMarks < 75 ? $('#editDriverTrialDate').val() : null,
      retakeDate: examMarks < 30 ? $('#editDriverRetakeDate').val() : null,
      status: $('#editDriverStatus').val()
    };

    Swal.fire({
      title: 'Success!',
      text: 'Driver information updated successfully',
      icon: 'success',
      confirmButtonText: 'OK'
    }).then(() => {
      $('#driverDetailsModal').modal('hide');
      renderDriversList();
    });
  }

  function confirmDeleteDriver(driverId) {
    const driver = drivers.find(d => d.id === driverId);
    if (!driver) return;

    Swal.fire({
      title: 'Confirm Deletion',
      html: `Are you sure you want to delete <strong>${driver.name}</strong> (${driver.licenseNumber})?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, delete',
      cancelButtonText: 'Cancel',
      confirmButtonColor: '#dc3545'
    }).then((result) => {
      if (result.isConfirmed) {
        deleteDriver(driverId);
      }
    });
  }

  function deleteDriver(driverId) {
    drivers = drivers.filter(d => d.id !== driverId);

    Swal.fire({
      title: 'Deleted!',
      text: 'Driver has been deleted',
      icon: 'success',
      confirmButtonText: 'OK'
    }).then(() => {
      renderDriversList();
    });
  }
</script>
</body>
</html>