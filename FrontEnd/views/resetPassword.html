<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../assets/images/titleIcon.png" type="image/x-icon">
  <title>Reset Password - SmartReg.lk</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.10.5/sweetalert2.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/resetPassword.css">

</head>
<body>

<div class="container-fluid vh-100 d-flex align-items-center">
  <div class="row w-100">
    <div class="content-container">
      <div class="card-glass p-4">
        <div class="text-center mb-4">
          <i class="fas fa-lock text-warning mb-3" style="font-size: 3rem;"></i>
          <h2 class="fw-bold mb-2">Reset Password</h2>
          <p class="text-secondary">Create a new password for your account</p>
          <div id="emailDisplay" class="text-muted small" style="display: none;">
            <i class="fas fa-envelope me-1"></i>
            <span id="displayEmail"></span>
          </div>
        </div>

        <form id="resetPasswordForm">
          <!-- Hidden email field populated from URL -->
          <input type="hidden" id="userEmail" value="">
          
          <div class="mb-3">
            <label for="newPassword" class="form-label">
              <i class="fas fa-key me-2"></i>New Password
            </label>
            <div class="password-container">
              <input type="password" class="form-control form-control-glass" id="newPassword"
                     placeholder="Enter your new password" required>
              <button type="button" class="password-toggle" id="toggleNewPassword">
                <i class="fas fa-eye-slash"></i>
              </button>
            </div>
            <div class="password-strength">
              <div class="strength-meter" id="passwordStrength"></div>
            </div>
            <div id="passwordFeedback" class="feedback">Password must be at least 8 characters long</div>
          </div>

          <div class="mb-3">
            <label for="confirmPassword" class="form-label">
              <i class="fas fa-key me-2"></i>Confirm Password
            </label>
            <div class="password-container">
              <input type="password" class="form-control form-control-glass" id="confirmPassword"
                     placeholder="Re-enter your new password" required>
              <button type="button" class="password-toggle" id="toggleConfirmPassword">
                <i class="fas fa-eye-slash"></i>
              </button>
            </div>
            <div id="passwordMatchFeedback" class="feedback"></div>
          </div>

          <button type="submit" class="btn btn-primary-glass w-100 mb-3" id="resetBtn">
            <i class="fas fa-save me-2"></i>Reset Password
          </button>

          <div class="text-center">
            <a href="../index.html" class="text-primary text-decoration-none">
              <i class="fas fa-arrow-left me-2"></i>Back to Login
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.10.5/sweetalert2.all.min.js"></script>

<script>
  $(document).ready(function() {
    // Configuration - Update with your actual backend URL
    const API_BASE_URL = 'http://localhost:8080/api/v1/auth';
    
    // Get email from URL parameters
    function getEmailFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('email') || '';
    }
    
    // Initialize page
    function initializePage() {
      const userEmail = getEmailFromUrl();
      
      if (userEmail) {
        $('#userEmail').val(userEmail);
        $('#displayEmail').text(userEmail);
        $('#emailDisplay').show();
      } else {
        // If no email in URL, redirect to forgot password or show error
        Swal.fire({
          title: 'Invalid Access',
          text: 'This page can only be accessed through a valid reset link sent to your email.',
          icon: 'error',
          confirmButtonColor: '#dc3545',
          confirmButtonText: 'Go to Forgot Password',
          allowOutsideClick: false,
          allowEscapeKey: false
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = 'forgetpassword.html'; // Update with your forgot password page
          }
        });
      }
    }
    
    // Initialize the page
    initializePage();

    // Password toggle functionality
    $('#toggleNewPassword').click(function() {
      const $input = $('#newPassword');
      const $icon = $(this).find('i');

      if ($input.attr('type') === 'password') {
        $input.attr('type', 'text');
        $icon.removeClass('fa-eye-slash').addClass('fa-eye');
      } else {
        $input.attr('type', 'password');
        $icon.removeClass('fa-eye').addClass('fa-eye-slash');
      }
    });

    $('#toggleConfirmPassword').click(function() {
      const $input = $('#confirmPassword');
      const $icon = $(this).find('i');

      if ($input.attr('type') === 'password') {
        $input.attr('type', 'text');
        $icon.removeClass('fa-eye-slash').addClass('fa-eye');
      } else {
        $input.attr('type', 'password');
        $icon.removeClass('fa-eye').addClass('fa-eye-slash');
      }
    });

    function checkPasswordStrength(password) {
      let strength = 0;

      if (password.length >= 8) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[a-z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;

      $('#passwordStrength').attr('class', 'strength-meter strength-' + strength);

      return strength;
    }

    // Password match checker
    function checkPasswordMatch() {
      const password = $('#newPassword').val();
      const confirmPassword = $('#confirmPassword').val();
      const $feedback = $('#passwordMatchFeedback');

      if (confirmPassword.length === 0) {
        $feedback.hide();
      } else if (password === confirmPassword) {
        $feedback.html('<i class="fas fa-check"></i> Passwords match').addClass('valid').removeClass('invalid').show();
      } else {
        $feedback.html('<i class="fas fa-times"></i> Passwords do not match').addClass('invalid').removeClass('valid').show();
      }
    }

    $('#newPassword').on('input', function() {
      const strength = checkPasswordStrength($(this).val());
      const $feedback = $('#passwordFeedback');

      if ($(this).val().length > 0) {
        $feedback.show();
      } else {
        $feedback.hide();
      }

      checkPasswordMatch();
    });

    $('#confirmPassword').on('input', checkPasswordMatch);

    // AJAX function to reset password
    function resetPassword(email, newPassword) {
      return $.ajax({
        url: API_BASE_URL + '/reset-password',
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({
          email: email,
          newPassword: newPassword
        }),
        timeout: 15000, // 15 second timeout
        beforeSend: function(xhr) {
          // Add any headers if needed (like CSRF token)
          // xhr.setRequestHeader('X-CSRF-TOKEN', $('meta[name="csrf-token"]').attr('content'));
        }
      });
    }

    // Form submission with AJAX integration
    $('#resetPasswordForm').on('submit', async function(e) {
      e.preventDefault();

      const email = $('#userEmail').val();
      const newPassword = $('#newPassword').val();
      const confirmPassword = $('#confirmPassword').val();

      // Validate email exists
      if (!email) {
        await Swal.fire({
          title: 'Invalid Access',
          text: 'No email found for password reset. Please use a valid reset link.',
          icon: 'error',
          confirmButtonColor: '#dc3545',
          confirmButtonText: 'OK'
        });
        return;
      }

      // Validate password strength
      const strength = checkPasswordStrength(newPassword);
      if (strength < 3) {
        await Swal.fire({
          title: 'Weak Password',
          text: 'Please choose a stronger password that meets all requirements (at least 8 characters, uppercase, lowercase, numbers)',
          icon: 'warning',
          confirmButtonColor: '#3085d6',
          confirmButtonText: 'OK'
        });
        return;
      }

      // Check password match
      if (newPassword !== confirmPassword) {
        await Swal.fire({
          title: 'Password Mismatch',
          text: 'The passwords you entered do not match',
          icon: 'error',
          confirmButtonColor: '#3085d6',
          confirmButtonText: 'OK'
        });
        return;
      }

      // Show loading state
      const $resetBtn = $('#resetBtn');
      const originalBtnText = $resetBtn.html();
      $resetBtn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Resetting...');
      $resetBtn.prop('disabled', true);

      try {
        // Make AJAX call to your Spring Boot backend
        const response = await resetPassword(email, newPassword);
        
        console.log('Password reset successful:', response);
        
        // Show success message
        await Swal.fire({
          title: 'Password Reset Successfully!',
          text: 'Your password has been updated successfully. You can now login with your new password.',
          icon: 'success',
          confirmButtonColor: '#28a745',
          confirmButtonText: 'Continue to Login',
          allowOutsideClick: false,
          allowEscapeKey: false
        });
        
        // Redirect to login page
        window.location.href = '../index.html';
        
      } catch (xhr) {
        console.error('Password reset failed:', xhr);
        
        let errorTitle = 'Reset Failed';
        let errorMessage = 'Failed to reset password. Please try again.';
        
        // Handle different error responses from your Spring Boot backend
        if (xhr.responseJSON) {
          const apiResponse = xhr.responseJSON;
          
          if (apiResponse.message) {
            errorMessage = apiResponse.message;
          }
          
          // Handle specific error codes from your ApiResponse
          switch (xhr.status) {
            case 400:
              errorTitle = 'Invalid Request';
              if (apiResponse.message === 'Email and new password are required') {
                errorMessage = 'Both email and password are required. Please try again.';
              } else if (apiResponse.message.includes('Database Error')) {
                errorMessage = 'User not found or database error. Please verify your email.';
              }
              break;
            case 500:
              errorTitle = 'Server Error';
              errorMessage = 'A server error occurred. Please try again later or contact support.';
              break;
            case 404:
              errorTitle = 'User Not Found';
              errorMessage = 'No user found with this email address. Please check your email.';
              break;
            default:
              errorMessage = apiResponse.message || errorMessage;
          }
        } else if (xhr.statusText === 'timeout') {
          errorTitle = 'Request Timeout';
          errorMessage = 'The request took too long. Please check your connection and try again.';
        } else if (xhr.status === 0) {
          errorTitle = 'Connection Error';
          errorMessage = 'Unable to connect to the server. Please check your internet connection.';
        }
        
        await Swal.fire({
          title: errorTitle,
          text: errorMessage,
          icon: 'error',
          confirmButtonColor: '#dc3545',
          confirmButtonText: 'Try Again'
        });
        
      } finally {
        // Reset button state
        $resetBtn.html(originalBtnText);
        $resetBtn.prop('disabled', false);
      }
    });

    // Prevent back button after successful reset (security measure)
    window.addEventListener('pageshow', function(event) {
      if (event.persisted) {
        window.location.reload();
      }
    });
  });
</script>
</body>
</html>