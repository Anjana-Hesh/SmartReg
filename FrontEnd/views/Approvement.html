<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../assets/images/titleIcon.png" type="image/x-icon">
<title>Driver License Applications</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
:root {
    --primary: #4e73df;
    --glass-bg: rgba(255, 255, 255, 0.08);
    --glass-border: rgba(255, 255, 255, 0.15);
    --text-light: #f5f5f5;
    --text-muted: rgba(255, 255, 255, 0.65);
}

body {
    background: linear-gradient(135deg, #141e30, #243b55);
    color: var(--text-light);
    font-family: "Segoe UI", Tahoma, sans-serif;
    min-height: 100vh;
}

.glass-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(12px);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    animation: fadeIn 0.4s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.table-glass {
    color: var(--text-light);
    border-collapse: separate;
    border-spacing: 0 8px;
}

.table-glass th {
    background: rgba(255, 255, 255, 0.1);
    border: none;
}

.table-glass td {
    background: rgba(255, 255, 255, 0.05);
    border: none;
    vertical-align: middle;
}

.table-glass tr:hover td {
    background: rgba(255, 255, 255, 0.12);
    transition: background 0.3s;
}

.photo-thumbnail {
    width: 45px;
    height: 45px;
    border-radius: 6px;
    object-fit: cover;
    cursor: pointer;
    border: 1px solid var(--glass-border);
    transition: transform 0.3s;
}

.photo-thumbnail:hover { transform: scale(1.08); }

.pdf-icon {
    color: #ff6b6b;
    font-size: 1.4rem;
    cursor: pointer;
    transition: transform 0.3s;
}

.pdf-icon:hover { transform: scale(1.15); }

.btn-approve {
    background: rgba(46, 204, 113, 0.2);
    border: 1px solid rgba(46, 204, 113, 0.4);
    color: #2ecc71;
    border-radius: 25px;
    padding: 4px 12px;
    transition: all 0.3s ease;
}
.btn-approve:hover {
    background: rgba(46, 204, 113, 0.35);
    color: white;
}

.btn-decline {
    background: rgba(231, 76, 60, 0.2);
    border: 1px solid rgba(231, 76, 60, 0.4);
    color: #e74c3c;
    border-radius: 25px;
    padding: 4px 12px;
    transition: all 0.3s ease;
}
.btn-decline:hover {
    background: rgba(231, 76, 60, 0.35);
    color: white;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.status-pending { background: rgba(241,196,15,0.2); color: #f1c40f; }
.status-approved { background: rgba(46,204,113,0.2); color: #2ecc71; }
.status-rejected { 
    background: rgba(231,76,60,0.2); 
    color: #e74c3c; 
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid rgba(231,76,60,0.3);
}

.status-rejected:hover {
    background: rgba(231,76,60,0.3);
    transform: scale(1.05);
}

.rejection-reason {
    background: rgba(231, 76, 60, 0.1);
    border: 1px solid rgba(231, 76, 60, 0.3);
    border-radius: 8px;
    padding: 10px 15px;
    margin-top: 8px;
    color: #ff6b6b;
    font-size: 0.85rem;
    display: none;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
    }
    to {
        opacity: 1;
        max-height: 100px;
        padding-top: 10px;
        padding-bottom: 10px;
    }
}

.rejection-reason.show {
    display: block;
}

.rejection-reason i {
    color: #e74c3c;
    margin-right: 8px;
}

.modal-content {
    background: rgba(30, 35, 50, 0.9);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(10px);
    color: var(--text-light);
}

.collapse-row {
    background: rgba(255, 255, 255, 0.05);
    padding: 10px;
}

.search-box {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--glass-border);
    color: white;
    border-radius: 25px;
    padding: 8px 15px;
    transition: all 0.3s;
}

.search-box:focus {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    box-shadow: none;
    border-color: var(--primary);
}

.filter-dropdown .dropdown-menu {
    background: rgba(30, 35, 50, 0.95);
    border: 1px solid var(--glass-border);
}

.filter-dropdown .dropdown-item {
    color: var(--text-light);
}

.filter-dropdown .dropdown-item:hover {
    background: var(--primary);
}

.pagination .page-link {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--glass-border);
    color: var(--text-light);
}

.pagination .page-link:hover {
    background: rgba(255, 255, 255, 0.1);
}

.pagination .active .page-link {
    background: var(--primary);
    border-color: var(--primary);
}

.rotate-icon {
    transition: transform 0.3s;
}

.rotate-icon.rotated {
    transform: rotate(180deg);
}

.empty-state {
    text-align: center;
    padding: 40px 0;
    color: var(--text-muted);
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.dropdown-toggle::after {
    display: none;
}

.chevron-cell {
    width: 40px;
    cursor: pointer;
}

.action-cell {
    white-space: nowrap;
}

.form-control {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--glass-border);
    color: var(--text-light);
}

.form-control:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--primary);
    color: var(--text-light);
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.form-select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--glass-border);
    color: var(--text-light);
}

.form-select:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--primary);
    color: var(--text-light);
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
}

.spinner-border {
    color: var(--primary);
}

.btn-back {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--glass-border);
    color: var(--text-light);
    border-radius: 25px;
    padding: 6px 15px;
    transition: all 0.3s ease;
    margin-right: 15px;
}

.btn-back:hover {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    transform: translateX(-3px);
}

.decline-reason-item {
    padding: 8px 12px;
    margin: 4px 0;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.decline-reason-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(5px);
}

.decline-reason-item i {
    color: #e74c3c;
    margin-right: 10px;
}

.vehicle-class-badge {
    display: inline-block;
    padding: 2px 8px;
    margin: 2px;
    background: rgba(78, 115, 223, 0.2);
    color: #4e73df;
    border: 1px solid rgba(78, 115, 223, 0.3);
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

/* File display styles */
.file-error {
    color: #ff6b6b;
    font-size: 0.8rem;
    text-align: center;
    padding: 10px;
}

.file-loading {
    color: #4e73df;
    font-size: 0.8rem;
    text-align: center;
    padding: 10px;
}

.photo-placeholder {
    width: 45px;
    height: 45px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px dashed var(--glass-border);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: 0.7rem;
}

.pdf-placeholder {
    color: #666;
    font-size: 1.4rem;
    opacity: 0.5;
}
</style>
</head>
<body>

<div class="loading-spinner">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container py-5">
    <div class="glass-card">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-light me-3" onclick="goBack()">
                    <i class="fas fa-arrow-left me-1"></i> Back
                </button>
                <h3 class="mb-0"><i class="fas fa-id-card me-2"></i>Driver License Applications</h3>
            </div>
            <div class="d-flex">
                <div class="input-group me-3" style="width: 250px;">
                    <span class="input-group-text bg-transparent border-end-0"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-box border-start-0" placeholder="Search..." id="searchInput">
                </div>
                <div class="filter-dropdown">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-filter me-1"></i>Filter
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                        <li><h6 class="dropdown-header">Status</h6></li>
                        <li><a class="dropdown-item filter-option" href="#" data-filter="status" data-value="all">All Applications</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item filter-option" href="#" data-filter="status" data-value="PENDING"><span class="status-badge status-pending me-2">Pending</span>Pending</a></li>
                        <li><a class="dropdown-item filter-option" href="#" data-filter="status" data-value="APPROVED"><span class="status-badge status-approved me-2">Approved</span>Approved</a></li>
                        <li><a class="dropdown-item filter-option" href="#" data-filter="status" data-value="REJECTED"><span class="status-badge status-rejected me-2">Rejected</span>Rejected</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">License Type</h6></li>
                        <li><a class="dropdown-item filter-option" href="#" data-filter="license" data-value="all">All Types</a></li>
                        <li><a class="dropdown-item filter-option" href="#" data-filter="license" data-value="LEARNER">Learner</a></li>
                        <li><a class="dropdown-item filter-option" href="#" data-filter="license" data-value="FULL">Full</a></li>
                        <li><a class="dropdown-item filter-option" href="#" data-filter="license" data-value="INTERNATIONAL">International</a></li>
                    </ul>
                </div>
                <button class="btn btn-outline-success ms-2" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-glass align-middle">
                <thead>
                    <tr>
                        <th class="chevron-cell"></th>
                        <th>Driver Name</th>
                        <th>License Type</th>
                        <th>Language</th>
                        <th>Status</th>
                        <th>Submitted</th>
                        <th class="action-cell">Actions</th>
                    </tr>
                </thead>
                <tbody id="applicationsTable">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
            
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-inbox"></i>
                <h4>No Applications Found</h4>
                <p>There are no driver license applications to display.</p>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted">
                    Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalItems">0</span> applications
                </div>
                <nav>
                    <ul class="pagination" id="pagination">
                        <!-- Pagination will be generated dynamically -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Driver Photo</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="enlargedPhoto" class="img-fluid rounded" style="max-height: 70vh;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- PDF Modal -->
<div class="modal fade" id="pdfModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Medical Certificate</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <iframe id="pdfViewer" width="100%" height="600px" style="border:none;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="pdfDownloadBtn" class="btn btn-primary" download>
                    <i class="fas fa-download me-1"></i> Download
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Approve Modal with Exam Date -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success me-2"></i>Approve Application
                </h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="fas fa-info-circle me-2"></i>
                    This action will approve the driver license application and schedule an exam.
                </div>
                
                <div class="mb-3">
                    <label for="examDate" class="form-label">
                        <i class="fas fa-calendar-alt me-2"></i>Exam Date <span class="text-danger">*</span>
                    </label>
                    <input type="date" class="form-control" id="examDate" required>
                    <div class="invalid-feedback">
                        Please select a valid exam date (must be in the future).
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="examTime" class="form-label">
                        <i class="fas fa-clock me-2"></i>Exam Time <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="examTime" required>
                        <option value="">Select Time</option>
                        <option value="09:00">09:00 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="14:00">02:00 PM</option>
                        <option value="15:00">03:00 PM</option>
                        <option value="16:00">04:00 PM</option>
                    </select>
                    <div class="invalid-feedback">
                        Please select an exam time.
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="examLocation" class="form-label">
                        <i class="fas fa-map-marker-alt me-2"></i>Exam Location
                    </label>
                    <select class="form-select" id="examLocation">
                        <option value="Colombo DMT">Colombo Department of Motor Traffic</option>
                        <option value="Kandy DMT">Kandy Department of Motor Traffic</option>
                        <option value="Galle DMT">Galle Department of Motor Traffic</option>
                        <option value="Kurunegala DMT">Kurunegala Department of Motor Traffic</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="approvalNotes" class="form-label">
                        <i class="fas fa-sticky-note me-2"></i>Notes (Optional)
                    </label>
                    <textarea class="form-control" id="approvalNotes" rows="3" placeholder="Additional notes for the applicant..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmApproveBtn">
                    <i class="fas fa-check me-1"></i> Approve & Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Decline Modal with Reasons -->
<div class="modal fade" id="declineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle text-danger me-2"></i>Decline Application
                </h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Please select a reason for declining this application. The applicant will be notified.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-list me-2"></i>Decline Reason <span class="text-danger">*</span>
                    </label>
                    <div class="decline-reasons">
                        <div class="decline-reason-item" data-reason="photo">
                            <i class="fas fa-camera"></i>
                            <strong>Photo Issues</strong>
                            <br><small class="text-muted">Photo quality is poor or doesn't meet requirements</small>
                        </div>
                        <div class="decline-reason-item" data-reason="medical">
                            <i class="fas fa-file-medical"></i>
                            <strong>Medical Certificate Issues</strong>
                            <br><small class="text-muted">Medical certificate is invalid or expired</small>
                        </div>
                        <div class="decline-reason-item" data-reason="documents">
                            <i class="fas fa-file-alt"></i>
                            <strong>Incomplete Documents</strong>
                            <br><small class="text-muted">Required documents are missing or incomplete</small>
                        </div>
                        <div class="decline-reason-item" data-reason="information">
                            <i class="fas fa-info-circle"></i>
                            <strong>Incorrect Information</strong>
                            <br><small class="text-muted">Personal information doesn't match documents</small>
                        </div>
                        <div class="decline-reason-item" data-reason="age">
                            <i class="fas fa-birthday-cake"></i>
                            <strong>Age Requirements</strong>
                            <br><small class="text-muted">Applicant doesn't meet age requirements</small>
                        </div>
                        <div class="decline-reason-item" data-reason="other">
                            <i class="fas fa-ellipsis-h"></i>
                            <strong>Other Reason</strong>
                            <br><small class="text-muted">Specify custom reason below</small>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3" id="customReasonDiv" style="display: none;">
                    <label for="customReason" class="form-label">Custom Reason</label>
                    <textarea class="form-control" id="customReason" rows="3" placeholder="Please specify the reason..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="declineNotes" class="form-label">
                        <i class="fas fa-comment me-2"></i>Additional Notes
                    </label>
                    <textarea class="form-control" id="declineNotes" rows="3" placeholder="Additional feedback for the applicant..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeclineBtn" disabled>
                    <i class="fas fa-times me-1"></i> Decline Application
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Configuration
const API_BASE_URL = "http://localhost:8080/api/v1";

// Get authentication data
const authToken = localStorage.getItem('smartreg_token') || sessionStorage.getItem('smartreg_token');
const userData = JSON.parse(localStorage.getItem('smartreg_user') || sessionStorage.getItem('smartreg_user') || '{}');

// Rejection reasons mapping
const rejectionReasons = {
    'photo': 'Photo quality is poor or doesn\'t meet requirements',
    'medical': 'Medical certificate is invalid or expired',
    'documents': 'Required documents are missing or incomplete', 
    'information': 'Personal information doesn\'t match documents',
    'age': 'Applicant doesn\'t meet age requirements',
    'other': 'Other reason specified by administrator'
};

// Application variables
let allApplications = [];
let filteredApplications = [];
let currentPage = 1;
const itemsPerPage = 10;
let currentApplicationId = null;
let selectedDeclineReason = '';
let showRejected = true; // Flag to toggle rejected applications visibility

// Check authentication
if (!authToken) {
    Swal.fire({
        title: "Authentication Required",
        text: "Please login to continue",
        icon: "error",
        background: "rgba(30, 35, 50, 0.95)",
        color: "#ffffff",
        confirmButtonText: "Go to Login",
        confirmButtonColor: "#4e73df"
    }).then(() => {
        window.location.href = "../index.html";
    });
}

function goBack() {
    window.history.back();
}

// Handle unauthorized access
function handleUnauthorized() {
    localStorage.removeItem('smartreg_token');
    localStorage.removeItem('smartreg_user');
    sessionStorage.removeItem('smartreg_token');
    sessionStorage.removeItem('smartreg_user');
    
    Swal.fire({
        title: "Session Expired",
        text: "Your session has expired. Please login again.",
        icon: "warning",
        background: "rgba(30, 35, 50, 0.95)",
        color: "#ffffff",
        confirmButtonText: "Go to Login",
        confirmButtonColor: "#4e73df"
    }).then(() => {
        window.location.href = "../index.html";
    });
}

// Setup AJAX defaults with authentication
$.ajaxSetup({
    beforeSend: function(xhr) {
        if (authToken) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + authToken);
        }
        xhr.setRequestHeader('Content-Type', 'application/json');
    },
    error: function(xhr, status, error) {
        console.error('AJAX Error:', {
            status: xhr.status,
            statusText: xhr.statusText,
            responseText: xhr.responseText,
            error: error
        });
        
        if (xhr.status === 401) {
            handleUnauthorized();
        } else if (xhr.status === 403) {
            showError("Access Denied", "You don't have permission to perform this action");
        } else if (xhr.status === 404) {
            showError("Not Found", "The requested resource was not found");
        } else if (xhr.status >= 500) {
            showError("Server Error", "Internal server error. Please try again later.");
        } else if (xhr.status === 0) {
            showError("Connection Error", "Cannot connect to server. Please check if the server is running.");
        }
    }
});

$(document).ready(function() {
    // Check admin role
    if (userData.role !== 'ADMIN' && (!userData.roles || !userData.roles.includes('ADMIN'))) {
        showError("Access Denied", "Only administrators can access this page");
        setTimeout(() => window.history.back(), 2000);
        return;
    }
    
    // Set minimum date for exam date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    $('#examDate').attr('min', tomorrow.toISOString().split('T')[0]);
    
    // Initialize
    loadApplications();
    
    // Event listeners
    $('#refreshBtn').on('click', loadApplications);
    $('#searchInput').on('input', handleSearch);
    $('.filter-option').on('click', handleFilter);
    
    // Modal event listeners
    $(document).on('click', '.approve-btn:not(:disabled)', handleApproveClick);
    $(document).on('click', '.decline-btn:not(:disabled)', handleDeclineClick);
    $('#confirmApproveBtn').on('click', handleApproveConfirm);
    $('#confirmDeclineBtn').on('click', handleDeclineConfirm);
    
    // Status badge click handler for rejected applications
    $(document).on('click', '.status-rejected', function(e) {
        e.stopPropagation();
        const appId = $(this).data('app-id');
        const reasonDiv = $(`#rejection-reason-${appId}`);
        
        if (reasonDiv.hasClass('show')) {
            reasonDiv.removeClass('show').slideUp(300);
        } else {
            $('.rejection-reason.show').removeClass('show').slideUp(300);
            reasonDiv.addClass('show').slideDown(300);
        }
    });
    
    // Toggle rejected applications button
    $('#toggleRejectedBtn').on('click', function() {
        showRejected = !showRejected;
        $(this).html(showRejected ? 
            '<i class="fas fa-eye-slash me-1"></i> Hide Rejected' : 
            '<i class="fas fa-eye me-1"></i> Show Rejected');
        renderApplications();
    });
    
    // Decline reason selection
    $('.decline-reason-item').on('click', function() {
        $('.decline-reason-item').removeClass('selected').css('background', 'rgba(255, 255, 255, 0.05)');
        $(this).addClass('selected').css('background', 'rgba(231, 76, 60, 0.2)');
        
        selectedDeclineReason = $(this).data('reason');
        $('#confirmDeclineBtn').prop('disabled', false);
        
        if (selectedDeclineReason === 'other') {
            $('#customReasonDiv').show();
        } else {
            $('#customReasonDiv').hide();
        }
    });
    
    // Photo modal handler
    $(document).on('click', '.photo-thumbnail', function() {
        const photoUrl = $(this).data('photo');
        $('#enlargedPhoto').attr('src', photoUrl);
    });
    
    // PDF modal handler  
    $(document).on('click', '.pdf-icon', function() {
        const pdfUrl = $(this).data('pdf');
        $('#pdfViewer').attr('src', pdfUrl);
        $('#pdfDownloadBtn').attr('href', pdfUrl);
    });
    
    // Chevron click handler
    $(document).on('click', '.chevron-cell', function(e) {
        e.stopPropagation();
        $(this).find('.rotate-icon').toggleClass('rotated');
    });
});

async function loadApplications() {
    showLoading();
    try {
        // Load applications
        const [applicationsResponse, declinesResponse] = await Promise.all([
            $.ajax({
                url: `${API_BASE_URL}/applications/getall`,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + authToken,
                    'Content-Type': 'application/json'
                }
            }),
            $.ajax({
                url: `${API_BASE_URL}/declines/getalldecines`,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + authToken,
                    'Content-Type': 'application/json'
                }
            })
        ]);
        
        // Map decline reasons to applications
        allApplications = applicationsResponse.map(app => {
            const declineInfo = declinesResponse.find(d => d.applicationId === app.id);
            if (declineInfo) {
                return {
                    ...app,
                    status: 'REJECTED',
                    rejectionReason: declineInfo.declineReason,
                    rejectionNotes: declineInfo.declineNotes
                };
            }
            return app;
        });
        
        filteredApplications = [...allApplications];
        renderApplications();
        
        if (allApplications.length === 0) {
            showInfo('No Applications', 'No driver license applications found.');
        }
        
    } catch (error) {
        console.error('Error loading applications:', error);
        handleLoadError(error);
    } finally {
        hideLoading();
    }
}

function handleLoadError(error) {
    let errorMessage = 'Failed to load applications';
    
    if (error.status === 0) {
        errorMessage = 'Cannot connect to server. Please ensure the backend server is running on http://localhost:8080';
    } else if (error.status === 401) {
        handleUnauthorized();
        return;
    } else if (error.status === 403) {
        errorMessage = 'You don\'t have permission to view applications.';
    } else {
        errorMessage = `Failed to load applications: ${error.statusText || 'Unknown error'}`;
    }
    
    $('#applicationsTable').html(`
        <tr>
            <td colspan="7" class="text-center py-5">
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                    <h5>Failed to Load Applications</h5>
                    <p class="text-muted mb-3">${errorMessage}</p>
                    <button class="btn btn-outline-primary" onclick="loadApplications()">
                        <i class="fas fa-retry me-1"></i> Retry
                    </button>
                </div>
            </td>
        </tr>
    `);
    $('#emptyState').hide();
}

function renderApplications() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    
    // Filter applications based on showRejected flag
    const visibleApplications = showRejected ? 
        filteredApplications : 
        filteredApplications.filter(app => app.status !== 'REJECTED');
    
    const pageApplications = visibleApplications.slice(startIndex, endIndex);
    
    if (pageApplications.length === 0) {
        $('#applicationsTable').empty();
        $('#emptyState').show();
        updatePaginationInfo(0, 0, 0);
        return;
    }
    
    $('#emptyState').hide();
    
    const tbody = $('#applicationsTable');
    tbody.empty();
    
    pageApplications.forEach((app, index) => {
        const rowHtml = generateApplicationRow(app, startIndex + index);
        tbody.append(rowHtml);
        
        setTimeout(() => {
            loadApplicationFiles(app);
        }, 100);
    });
    
    updatePaginationInfo(startIndex + 1, Math.min(endIndex, visibleApplications.length), visibleApplications.length);
    generatePagination();
}

async function loadApplicationFiles(app) {
    if (app.photoPath) {
        try {
            const photoResponse = await fetch(`${API_BASE_URL}/files/${app.photoPath}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            });
            
            if (photoResponse.ok) {
                const photoBlob = await photoResponse.blob();
                const photoUrl = URL.createObjectURL(photoBlob);
                
                const smallPhotoDiv = $(`#photo-${app.id}`);
                if (smallPhotoDiv.length) {
                    smallPhotoDiv.html(`<img src="${photoUrl}" class="rounded-circle" width="30" height="30" style="object-fit: cover;">`);
                }
                
                const detailPhotoDiv = $(`#photo-detail-${app.id}`);
                if (detailPhotoDiv.length) {
                    detailPhotoDiv.html(`
                        <img src="${photoUrl}" 
                             class="photo-thumbnail"
                             data-bs-toggle="modal" data-bs-target="#photoModal"
                             data-photo="${photoUrl}"
                             style="cursor: pointer;">
                    `);
                }
            }
        } catch (error) {
            console.error(`Error loading photo for application ${app.id}:`, error);
        }
    }
    
    if (app.medicalCertificatePath) {
        try {
            const pdfResponse = await fetch(`${API_BASE_URL}/files/${app.medicalCertificatePath}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            });
            
            if (pdfResponse.ok) {
                const pdfBlob = await pdfResponse.blob();
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                const pdfDiv = $(`#pdf-detail-${app.id}`);
                if (pdfDiv.length) {
                    pdfDiv.html(`
                        <i class="fas fa-file-pdf pdf-icon"
                           data-bs-toggle="modal" data-bs-target="#pdfModal"
                           data-pdf="${pdfUrl}" 
                           title="Medical Certificate"
                           style="cursor: pointer;"></i>
                    `);
                }
            }
        } catch (error) {
            console.error(`Error loading PDF for application ${app.id}:`, error);
        }
    }
}

function generateApplicationRow(app, index) {
    const statusClass = getStatusClass(app.status);
    const statusText = app.status ? app.status.charAt(0).toUpperCase() + app.status.slice(1).toLowerCase() : 'Unknown';
    const isDisabled = app.status !== 'PENDING' ? 'disabled' : '';
    
    const driverName = app.driver || 'Unknown Driver';
    
    let rejectionReasonHtml = '';
    if (app.status === 'REJECTED' && app.rejectionReason) {
        const reasonText = rejectionReasons[app.rejectionReason] || app.rejectionReason;
        rejectionReasonHtml = `
            <div id="rejection-reason-${app.id}" class="rejection-reason">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Rejection Reason:</strong> ${reasonText}
                ${app.rejectionNotes ? `<br><small>Notes: ${app.rejectionNotes}</small>` : ''}
            </div>
        `;
    }
    
    return `
        <tr>
            <td class="chevron-cell" data-bs-toggle="collapse" data-bs-target="#details${app.id}" aria-expanded="false">
                <i class="fas fa-chevron-down rotate-icon"></i>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <div id="photo-${app.id}" class="rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 30px; height: 30px; background: rgba(78, 115, 223, 0.2); color: #4e73df; font-size: 0.7rem;">
                        <i class="fas fa-user"></i>
                    </div>
                    <span>${driverName}</span>
                </div>
            </td>
            <td>${app.licenseType || 'N/A'}</td>
            <td>${app.examLanguage || 'N/A'}</td>
            <td>
                <span class="status-badge ${statusClass}" ${app.status === 'REJECTED' ? `data-app-id="${app.id}" title="Click to view rejection reason"` : ''}>
                    ${statusText}
                </span>
                ${rejectionReasonHtml}
            </td>
            <td>${formatDate(app.submittedDate)}</td>
            <td class="action-cell">
                <button class="btn btn-sm btn-approve me-1 approve-btn" data-id="${app.id}" ${isDisabled}>
                    <i class="fas fa-check"></i> Approve
                </button>
                <button class="btn btn-sm btn-decline decline-btn" data-id="${app.id}" ${isDisabled}>
                    <i class="fas fa-times"></i> Decline
                </button>
            </td>
        </tr>
        <tr class="collapse" id="details${app.id}">
            <td colspan="7" class="collapse-row">
                ${generateDetailsRow(app)}
            </td>
        </tr>
    `;
}

function generateDetailsRow(app) {
    return `
        <div class="row">
            <div class="col-md-4">
                <strong>Vehicle Classes:</strong> ${formatVehicleClasses(app.vehicleClasses)}<br>
                <strong>NIC:</strong> ${app.nicNumber || 'N/A'}<br>
                <strong>DOB:</strong> ${formatDate(app.dateOfBirth)}<br>
                <strong>Blood Group:</strong> ${app.bloodGroup || 'N/A'}
                ${app.examDate ? `<br><strong>Exam Date:</strong> ${formatDate(app.examDate)}` : ''}
            </div>
            <div class="col-md-4">
                <strong>Phone:</strong> ${app.phoneNumber || 'N/A'}<br>
                <strong>Email:</strong> ${app.email || 'N/A'}<br>
                <strong>Address:</strong> ${app.address || 'N/A'}
            </div>
            <div class="col-md-2 text-center">
                <strong>Photo</strong><br>
                <div id="photo-detail-${app.id}" class="photo-placeholder mt-1" style="width: 45px; height: 45px; margin: 0 auto;">
                    <i class="fas fa-user" style="line-height: 45px;"></i>
                </div>
            </div>
            <div class="col-md-2 text-center">
                <strong>Documents</strong><br>
                <div id="pdf-detail-${app.id}" class="mt-1">
                    <i class="fas fa-file-pdf pdf-placeholder" title="Loading..."></i>
                </div>
            </div>
        </div>
    `;
}

function formatVehicleClasses(classes) {
    if (!classes || !Array.isArray(classes) || classes.length === 0) {
        return '<span class="text-muted">None</span>';
    }
    return classes.map(cls => `<span class="vehicle-class-badge">${cls}</span>`).join(' ');
}

function getStatusClass(status) {
    switch (status?.toUpperCase()) {
        case 'PENDING': return 'status-pending';
        case 'APPROVED': return 'status-approved';
        case 'REJECTED': return 'status-rejected';
        default: return 'status-pending';
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        return new Date(dateString).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch (error) {
        return dateString;
    }
}

function handleSearch() {
    const searchTerm = $('#searchInput').val().toLowerCase().trim();
    
    if (searchTerm === '') {
        filteredApplications = [...allApplications];
    } else {
        filteredApplications = allApplications.filter(app => {
            const driverName = app.driver ? (app.driver.firstName + ' ' + app.driver.lastName).toLowerCase() : '';
            return driverName.includes(searchTerm) ||
                   (app.nicNumber?.toLowerCase().includes(searchTerm)) ||
                   (app.driver?.email?.toLowerCase().includes(searchTerm)) ||
                   (app.phoneNumber?.includes(searchTerm)) ||
                   (app.licenseType?.toLowerCase().includes(searchTerm));
        });
    }
    
    currentPage = 1;
    renderApplications();
}

function handleFilter(e) {
    e.preventDefault();
    const filterType = $(this).data('filter');
    const filterValue = $(this).data('value');
    
    if (filterValue === 'all') {
        filteredApplications = [...allApplications];
    } else {
        if (filterType === 'status') {
            filteredApplications = allApplications.filter(app => app.status?.toUpperCase() === filterValue);
        } else if (filterType === 'license') {
            filteredApplications = allApplications.filter(app => app.licenseType?.toUpperCase() === filterValue);
        }
    }
    
    currentPage = 1;
    renderApplications();
}

function handleApproveClick(e) {
    e.stopPropagation();
    currentApplicationId = $(this).data('id');
    
    $('#examDate').val('');
    $('#examTime').val('');
    $('#examLocation').val('Colombo DMT');
    $('#approvalNotes').val('');
    
    $('#examDate, #examTime').removeClass('is-invalid');
    
    const approveModal = new bootstrap.Modal(document.getElementById('approveModal'));
    approveModal.show();
}

function handleDeclineClick(e) {
    e.stopPropagation();
    currentApplicationId = $(this).data('id');
    
    $('.decline-reason-item').removeClass('selected').css('background', 'rgba(255, 255, 255, 0.05)');
    $('#customReason').val('');
    $('#declineNotes').val('');
    $('#customReasonDiv').hide();
    $('#confirmDeclineBtn').prop('disabled', true);
    selectedDeclineReason = '';
    
    const declineModal = new bootstrap.Modal(document.getElementById('declineModal'));
    declineModal.show();
}
// Updated handleApproveConfirm function in your frontend
async function handleApproveConfirm() {
    const examDate = $('#examDate').val();
    const examTime = $('#examTime').val();
    const examLocation = $('#examLocation').val();
    const approvalNotes = $('#approvalNotes').val();
    
    let isValid = true;
    
    // Validation
    if (!examDate) {
        $('#examDate').addClass('is-invalid');
        isValid = false;
    } else {
        const selectedDate = new Date(examDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate <= today) {
            $('#examDate').addClass('is-invalid');
            isValid = false;
        } else {
            $('#examDate').removeClass('is-invalid');
        }
    }
    
    if (!examTime) {
        $('#examTime').addClass('is-invalid');
        isValid = false;
    } else {
        $('#examTime').removeClass('is-invalid');
    }
    
    if (!isValid) {
        return;
    }
    
    showLoading();
    
    try {
        // First, approve the application
        await $.ajax({
            url: `${API_BASE_URL}/applications/${currentApplicationId}/status?status=APPROVED`,
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + authToken,
                'Content-Type': 'application/json'
            }
        });
        
        // Then, schedule the written exam
        const writtenExamData = {
            applicationId: currentApplicationId,
            writtenExamDate: examDate,
            writtenExamTime: examTime,
            writtenExamLocation: examLocation || 'Colombo Department of Motor Traffic',
            note: approvalNotes || 'Application approved and exam scheduled',
            writtenExamResult: null // Will be updated after exam
        };
        
        await $.ajax({
            url: `${API_BASE_URL}/written-exams/schedule`,
            method: 'POST',
            data: JSON.stringify(writtenExamData),
            headers: {
                'Authorization': 'Bearer ' + authToken,
                'Content-Type': 'application/json'
            }
        });
        
        // Update local data
        updateApplicationStatus(currentApplicationId, 'APPROVED', examDate);
        
        // Hide modal and refresh display
        const approveModal = bootstrap.Modal.getInstance(document.getElementById('approveModal'));
        approveModal.hide();
        
        renderApplications();
        showSuccess('Application Approved', 
            `Application has been approved successfully. Written exam scheduled for ${formatDate(examDate)} at ${examTime} in ${examLocation}.`);
        
    } catch (error) {
        console.error('Error approving application:', error);
        if (error.responseJSON && error.responseJSON.message) {
            showError('Approval Failed', error.responseJSON.message);
        } else {
            handleActionError(error, 'approve');
        }
    } finally {
        hideLoading();
    }
}

async function handleDeclineConfirm() {
    if (!selectedDeclineReason) {
        showError('Error', 'Please select a decline reason');
        return;
    }

    showLoading();
    
    try {
        // Get decline notes and custom reason
        const declineNotes = $('#declineNotes').val();
        let customReason = '';
        if (selectedDeclineReason === 'other') {
            customReason = $('#customReason').val();
            if (!customReason || customReason.trim() === '') {
                showError('Error', 'Please specify a custom reason');
                hideLoading();
                return;
            }
        }

        // Prepare simple decline data
        const declineData = {
            applicationId: currentApplicationId,
            declineReason: selectedDeclineReason,
            declineNotes: declineNotes || customReason,
            declinedBy: userData.username || 'Admin'
            // declinedAt will be set by backend
        };

        // First, update the application status to REJECTED
        await $.ajax({
            url: `${API_BASE_URL}/applications/${currentApplicationId}/status?status=REJECTED`,
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + authToken,
                'Content-Type': 'application/json'
            }
        });

        // Then, save the simple decline details
        await $.ajax({
            url: `${API_BASE_URL}/declines/create-decline`,
            method: 'POST',
            data: JSON.stringify(declineData),
            headers: {
                'Authorization': 'Bearer ' + authToken,
                'Content-Type': 'application/json'
            }
        });

        // Update local data with rejection reason
        updateApplicationStatus(
            currentApplicationId, 
            'REJECTED', 
            null, 
            selectedDeclineReason, 
            declineNotes || customReason
        );

        // Hide modal and refresh display
        const declineModal = bootstrap.Modal.getInstance(document.getElementById('declineModal'));
        declineModal.hide();

        renderApplications();
        
        let reasonText = getDeclineReasonText(selectedDeclineReason);
        if (selectedDeclineReason === 'other') {
            reasonText = customReason || 'Other reason specified';
        }
        
        showSuccess('Application Declined', `Application has been declined. Reason: ${reasonText}`);
        
    } catch (error) {
        console.error('Error declining application:', error);
        showError('Decline Failed', 'Failed to decline application. Please try again.');
    } finally {
        hideLoading();
    }
}

function updateApplicationStatus(applicationId, status, examDate = null, rejectionReason = null, rejectionNotes = null) {
    const appIndex = allApplications.findIndex(app => app.id === applicationId);
    if (appIndex !== -1) {
        allApplications[appIndex].status = status;
        if (examDate) allApplications[appIndex].examDate = examDate;
        if (rejectionReason) allApplications[appIndex].rejectionReason = rejectionReason;
        if (rejectionNotes) allApplications[appIndex].rejectionNotes = rejectionNotes;
    }
    
    const filteredIndex = filteredApplications.findIndex(app => app.id === applicationId);
    if (filteredIndex !== -1) {
        filteredApplications[filteredIndex].status = status;
        if (examDate) filteredApplications[filteredIndex].examDate = examDate;
        if (rejectionReason) filteredApplications[filteredIndex].rejectionReason = rejectionReason;
        if (rejectionNotes) filteredApplications[filteredIndex].rejectionNotes = rejectionNotes;
    }
}

function handleActionError(error, action) {
    if (error.status === 401) {
        handleUnauthorized();
    } else if (error.status === 403) {
        showError('Access Denied', `You don't have permission to ${action} applications.`);
    } else if (error.status === 404) {
        showError('Not Found', 'Application not found or may have been deleted.');
    } else {
        showError('Error', `Failed to ${action} application: ${error.statusText || 'Unknown error'}`);
    }
}

function getDeclineReasonText(reason) {
    const reasons = {
        'photo': 'Photo Issues',
        'medical': 'Medical Certificate Issues', 
        'documents': 'Incomplete Documents',
        'information': 'Incorrect Information',
        'age': 'Age Requirements',
        'other': 'Other Reason'
    };
    return reasons[reason] || 'Unknown Reason';
}

function updatePaginationInfo(from, to, total) {
    $('#showingFrom').text(from);
    $('#showingTo').text(to);
    $('#totalItems').text(total);
}

function generatePagination() {
    const visibleApplications = showRejected ? 
        filteredApplications : 
        filteredApplications.filter(app => app.status !== 'REJECTED');
    
    const totalPages = Math.ceil(visibleApplications.length / itemsPerPage);
    const pagination = $('#pagination');
    pagination.empty();
    
    if (totalPages <= 1) return;
    
    const prevDisabled = currentPage === 1 ? 'disabled' : '';
    pagination.append(`
        <li class="page-item ${prevDisabled}">
            <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
        </li>
    `);
    
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        pagination.append(`
            <li class="page-item ${activeClass}">
                <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>
        `);
    }
    
    const nextDisabled = currentPage === totalPages ? 'disabled' : '';
    pagination.append(`
        <li class="page-item ${nextDisabled}">
            <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
        </li>
    `);
    
    pagination.find('.page-link').on('click', function(e) {
        e.preventDefault();
        const newPage = parseInt($(this).data('page'));
        if (newPage && newPage !== currentPage && newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderApplications();
        }
    });
}

function showLoading() {
    $('.loading-spinner').show();
}

function hideLoading() {
    $('.loading-spinner').hide();
}

function showSuccess(title, message) {
    Swal.fire({
        title: title,
        text: message,
        icon: "success",
        background: "rgba(30, 35, 50, 0.95)",
        color: "#ffffff",
        confirmButtonColor: "#2ecc71",
        timer: 3000,
        timerProgressBar: true
    });
}

function showError(title, message) {
    Swal.fire({
        title: title,
        text: message,
        icon: "error",
        background: "rgba(30, 35, 50, 0.95)",
        color: "#ffffff",
        confirmButtonColor: "#e74c3c"
    });
}

function showInfo(title, message) {
    Swal.fire({
        title: title,
        text: message,
        icon: "info",
        background: "rgba(30, 35, 50, 0.95)",
        color: "#ffffff",
        confirmButtonColor: "#4e73df"
    });
}
</script>

</body>
</html>