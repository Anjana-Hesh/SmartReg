<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Staff Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/staffManagement.css"/>

</head>
<body>

<div class="container glass-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Manage Staff Members</h3>
        <button id="addStaffBtn" class="btn btn-primary btn-glass" data-bs-toggle="modal" data-bs-target="#staffModal">
            <i class="fas fa-user-plus"></i> Add Staff
        </button>
    </div>

    <table class="table table-bordered table-hover text-center">
        <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>Staff ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Status</th>
            <th>Admin</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="staffTable"></tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="staffModal" tabindex="-1" aria-labelledby="staffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form id="staffForm" class="modal-content p-4">
            <div class="modal-header">
                <h5 class="modal-title" id="staffModalLabel">Add Staff Member</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Hidden field to hold edit index -->
                <input type="hidden" id="editingIndex" value="">
                <div class="mb-3">
                    <label for="name" class="form-label">Name</label>
                    <input type="text" class="form-control" id="name" placeholder="Enter full name" required />
                </div>

                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" placeholder="Enter username" required />
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" placeholder="Enter password" required />
                    <div id="passwordStrength" class="password-strength strength-0"></div>
                    <small id="passwordHelp" class="form-text text-muted"></small>
                </div>

                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" placeholder="Enter email" required />
                </div>

                <div class="mb-3">
                    <label for="phone" class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="phone" placeholder="Enter phone number" required />
                </div>

                <div class="mb-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" required>
                        <option value="Active" selected>Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div class="mb-3 form-check form-switch">
                    <input type="checkbox" class="form-check-input" id="isAdmin" />
                    <label class="form-check-label" for="isAdmin">Make Admin</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="saveBtn" type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const staffTable = document.getElementById('staffTable');
    const staffForm = document.getElementById('staffForm');
    const staffModalLabel = document.getElementById('staffModalLabel');
    const saveBtn = document.getElementById('saveBtn');
    const editingIndexInput = document.getElementById('editingIndex');
    const addStaffBtn = document.getElementById('addStaffBtn');
    const passwordInput = document.getElementById('password');
    const passwordStrength = document.getElementById('passwordStrength');
    const passwordHelp = document.getElementById('passwordHelp');

    // Password validation state
    let passwordAttempts = 0;
    let isLocked = false;
    let unlockTime = 0;

    // Sample data
    let staffList = [
        { staffId: 'STF001', name: 'Jane Doe', username: 'jane.doe', password: 'SecurePass123!', email: 'jane@example.com', phone: '0771234567', status: 'Active', isAdmin: true },
        { staffId: 'STF002', name: 'John Smith', username: 'john.smith', password: 'StrongPass456!', email: 'john@example.com', phone: '0777654321', status: 'Inactive', isAdmin: false },
    ];

    // Generate staff ID
    function generateStaffId() {
        const lastId = staffList.length > 0 ?
            parseInt(staffList[staffList.length - 1].staffId.replace('STF', '')) : 0;
        return 'STF' + (lastId + 1).toString().padStart(3, '0');
    }

    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;

        // Length check
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;

        // Complexity checks
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;

        return Math.min(strength, 4);
    }

    // Update password strength meter
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        const strength = checkPasswordStrength(password);

        // Update strength meter
        passwordStrength.className = 'password-strength strength-' + strength;

        // Update help text
        if (password.length === 0) {
            passwordHelp.textContent = '';
        } else if (password.length < 8) {
            passwordHelp.textContent = 'Password too short (min 8 characters)';
            passwordHelp.style.color = '#dc3545';
        } else if (strength < 3) {
            passwordHelp.textContent = 'Weak password - include uppercase, numbers & symbols';
            passwordHelp.style.color = '#ffc107';
        } else {
            passwordHelp.textContent = 'Strong password';
            passwordHelp.style.color = '#28a745';
        }
    });

    // Render staff table
    function renderTable() {
        staffTable.innerHTML = '';
        staffList.forEach((staff, i) => {
            staffTable.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${staff.staffId}</td>
                    <td>${staff.name}</td>
                    <td>${staff.email}</td>
                    <td><span class="badge bg-${staff.status === 'Active' ? 'success' : 'secondary'}">${staff.status}</span></td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" ${staff.isAdmin ? 'checked' : ''}
                                onchange="toggleAdmin(${i})" ${staff.staffId === 'STF001' ? 'disabled' : ''} />
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-warning-glass btn-sm me-1" onclick="editStaff(${i})"
                            data-bs-toggle="modal" data-bs-target="#staffModal">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger-glass btn-sm" onclick="confirmDeleteStaff(${i})"
                            ${staff.staffId === 'STF001' ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
        });
    }

    // Add or update staff
    staffForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Check if account is locked
        if (isLocked) {
            const remainingTime = Math.ceil((unlockTime - Date.now()) / 1000 / 60);
            Swal.fire({
                icon: 'error',
                title: 'Account Locked',
                text: `Too many failed attempts. Try again in ${remainingTime} minute(s).`,
            });
            return;
        }

        // Validate password
        const password = document.getElementById('password').value;
        if (password.length < 8) {
            passwordAttempts++;
            if (passwordAttempts >= 3) {
                lockAccount();
                return;
            }
            Swal.fire({
                icon: 'error',
                title: 'Weak Password',
                text: 'Password must be at least 8 characters long.',
            });
            return;
        }

        // Get form values
        const staffId = generateStaffId();
        const name = document.getElementById('name').value.trim();
        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const status = document.getElementById('status').value;
        const isAdmin = document.getElementById('isAdmin').checked;
        const editingIndex = editingIndexInput.value;

        if (editingIndex === '') {
            // Add new staff
            staffList.push({ staffId, name, username, password, email, phone, status, isAdmin });
            await Swal.fire({
                icon: 'success',
                title: 'Staff Added',
                text: `${name} has been added successfully.`,
                timer: 2000,
                showConfirmButton: false
            });
        } else {
            // Update existing staff
            staffList[editingIndex] = { ...staffList[editingIndex], name, username, password, email, phone, status, isAdmin };
            await Swal.fire({
                icon: 'success',
                title: 'Staff Updated',
                text: `${name}'s details have been updated.`,
                timer: 2000,
                showConfirmButton: false
            });
        }

        renderTable();
        staffForm.reset();
        editingIndexInput.value = '';
        staffModalLabel.textContent = 'Add Staff Member';
        saveBtn.textContent = 'Save';

        // Hide modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('staffModal'));
        modal.hide();

        // Reset attempts on successful submission
        passwordAttempts = 0;
    });

    // Lock account function
    function lockAccount() {
        isLocked = true;
        unlockTime = Date.now() + 60000; // 1 minute lock

        Swal.fire({
            icon: 'error',
            title: 'Too Many Attempts',
            text: 'Your account has been locked for 1 minute due to multiple failed attempts.',
            timer: 5000
        });

        // Unlock after 1 minute
        setTimeout(() => {
            isLocked = false;
            passwordAttempts = 0;
        }, 60000);
    }

    // Edit staff
    function editStaff(index) {
        const staff = staffList[index];
        document.getElementById('name').value = staff.name;
        document.getElementById('username').value = staff.username;
        document.getElementById('password').value = staff.password;
        document.getElementById('email').value = staff.email;
        document.getElementById('phone').value = staff.phone;
        document.getElementById('status').value = staff.status;
        document.getElementById('isAdmin').checked = staff.isAdmin;
        editingIndexInput.value = index;

        staffModalLabel.textContent = 'Edit Staff Member';
        saveBtn.textContent = 'Update';

        // Trigger password strength update
        const event = new Event('input');
        passwordInput.dispatchEvent(event);
    }

    // Confirm delete staff
    function confirmDeleteStaff(index) {
        const staff = staffList[index];
        Swal.fire({
            title: 'Delete Staff Member?',
            text: `Are you sure you want to delete ${staff.name}? This action cannot be undone.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                deleteStaff(index);
            }
        });
    }

    // Delete staff
    function deleteStaff(index) {
        const staffName = staffList[index].name;
        staffList.splice(index, 1);
        renderTable();

        Swal.fire({
            icon: 'success',
            title: 'Deleted!',
            text: `${staffName} has been removed from the system.`,
            timer: 2000,
            showConfirmButton: false
        });
    }

    // Toggle admin status
    function toggleAdmin(index) {
        staffList[index].isAdmin = !staffList[index].isAdmin;
        const action = staffList[index].isAdmin ? 'granted' : 'revoked';

        Swal.fire({
            icon: 'success',
            title: 'Admin Access Updated',
            text: `Admin privileges ${action} for ${staffList[index].name}.`,
            timer: 2000,
            showConfirmButton: false
        });
    }

    // Clear form when Add Staff button clicked
    addStaffBtn.addEventListener('click', () => {
        staffForm.reset();
        editingIndexInput.value = '';
        staffModalLabel.textContent = 'Add Staff Member';
        saveBtn.textContent = 'Save';
        passwordStrength.className = 'password-strength strength-0';
        passwordHelp.textContent = '';
    });

    // Initial render
    renderTable();
</script>

</body>
</html>